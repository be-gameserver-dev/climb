const canvas=document.getElementById("screen"),ctx=canvas.getContext("2d");ctx.imageSmoothingEnabled=!1;const SCREEN_SIZE_X=15,SCREEN_SIZE_Y=12,TILE_SIZE=22;export function GetTilePos(t,e){const o=canvas.width/15,a=canvas.height/12,i=Math.floor(7*o);return{x:Math.ceil(i+t*o),y:Math.ceil(e*a),w:Math.ceil(o),h:Math.ceil(a)}}export const BG_tile_imgs={isLoaded:!1};export const Char_tile_imgs={isLoaded:!1};export const Dialog_tile_imgs={isLoaded:!1};export const BGimg=new Image;BGimg.src="./Assets/Image/BG.png";export const Dialogimg=new Image;Dialogimg.src="./Assets/Image/dialog.png";const Charimg_cup=new Image,Charimg_kris=new Image;function createTile(t,e,o,a,i,n=1){const s=document.createElement("canvas");s.width=Math.round(a*n),s.height=Math.round(i*n);const r=s.getContext("2d");return r.imageSmoothingEnabled=!1,r.drawImage(t,Math.round(e),Math.round(o),Math.round(a),Math.round(i),0,0,s.width,s.height),s}function OnImageLoad(t,e,o,a,i=0){let n=i;for(let i=0;i<a;i++)for(let a=0;a<o;a++)e[n++]=createTile(t,22*a,22*i,22,22)}BGimg.onload=()=>{OnImageLoad(BGimg,BG_tile_imgs,24,25),BG_tile_imgs.isLoaded=!0},Dialogimg.onload=()=>{OnImageLoad(Dialogimg,Dialog_tile_imgs,4,3),Dialog_tile_imgs.isLoaded=!0},Charimg_cup.onload=()=>{OnImageLoad(Charimg_cup,Char_tile_imgs,8,2),Charimg_kris.onload=()=>{OnImageLoad(Charimg_kris,Char_tile_imgs,8,3,Object.keys(Char_tile_imgs).length-1),Char_tile_imgs.isLoaded=!0},Charimg_kris.src="./Assets/Image/kris.png"},Charimg_cup.src="./Assets/Image/cuptain.png";export function clearScreen(){ctx.clearRect(0,0,canvas.width,canvas.height)}export function DrawTile(t,e,o,a=!1,i=!1){if(!t)return;const n=GetTilePos(e,o);ctx.save(),ctx.translate(n.x+n.w/2,n.y+n.h/2),ctx.scale(a?-1:1,i?-1:1),ctx.imageSmoothingEnabled=!1,ctx.drawImage(t,-n.w/2,-n.h/2,n.w,n.h),ctx.restore()}export function drawModel(t,e,o,a){const i=e.replace(/[\r\n]/g," ").trim().split(/\s+/);let n=0,s=0,r=0,c=0,l=!1,g=!1,m=1;function x(e){if("#"===e[0]){const t=e.slice(1);return void("n"===t?(r=0,c+=1):t.startsWith("xo")?n=parseFloat(t.slice(2)):t.startsWith("yo")?s=parseFloat(t.slice(2)):"fx"===t?l=!l:"fy"===t&&(g=!g))}const i=Number(e);Number.isInteger(i)&&null!=t[i]&&(DrawTile(t[i],o+r+n,a+c+s,l,g),r+=1)}for(const t of i){if("#"===t[0]){const e=t.slice(1);if(e.startsWith("r")){const t=Number(e.slice(1));Number.isInteger(t)&&t>0&&(m=t);continue}}for(let e=0;e<m;e++)x(t);m=1}}export const texts=new Map;export function createUUID(){return crypto.randomUUID()}export function getTileSize(){return Math.floor(canvas.width/15)}export function getFontSize(t){return Math.max(1,Math.floor(getTileSize()*t))}export function applyRenderState(){ctx.setTransform(1,0,0,1,0,0),ctx.imageSmoothingEnabled=!1,ctx.fillStyle="#fff",ctx.textBaseline="top",ctx.textAlign="left"}export async function startFontSystem(){await document.fonts.ready}startFontSystem();export function addText(t,e,o,a=1){const i=createUUID();return texts.set(i,{id:i,text:t,x:e,y:o,scale:a}),i}export function removeText(t){texts.delete(t)}export function replaceText(t,e,o,a,i){const n=texts.get(t);n&&(n.text=e,n.x=o,n.y=a,void 0!==i&&(n.scale=i))}export function drawTexts(){if(0!==texts.size)for(const t of texts.values()){const e=GetTilePos(t.x,t.y),o=getFontSize(t.scale);ctx.font=`${o}px Font`,ctx.fillText(t.text,Math.floor(e.x),Math.floor(e.y))}}