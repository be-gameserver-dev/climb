import{Map}from"./map.js";import{Player}from"./player.js";import{DrawTile,BG_tile_imgs,Dialog_tile_imgs,clearScreen,drawTexts,applyRenderState,addText,removeText,replaceText,drawModel}from"./render.js";console.clear();let debug_mode={enabled:!0};globalThis.debug_mode=debug_mode,Object.seal(debug_mode);const gameSetting={boostmode:!1},player=new Player,camera={x:0,y:0},map=new Map;function drawMap(e,t,a=0,r=0){for(const[o,s]of Object.entries(t)){const t=parseInt(o,16);if(!(t>12))for(let o=e.x-7;o<=e.x+7;o++){const e=s[o];if("number"==typeof e)DrawTile(BG_tile_imgs[e],o+a,t+r);else if(null!==e&&"object"==typeof e){const s=e.id,i=e.xflip,n=e.yflip;if("number"!=typeof s)continue;DrawTile(BG_tile_imgs[s],o+a,t+r,i,n)}else"string"==typeof e&&"path"==e&&DrawTile(BG_tile_imgs[274],o+a,t+r)}}}function drawDialog(e="base"){let t,a=0,r=0;switch(e){case"base":t="\n    10 0 #r11 4 1 10 #n\n    10 7 #r11 8 5 10 #n\n    10 7 #r11 8 5 10 #n\n    10 2 #r11 6 3 10",a=-7,r=8;break;case"setting":case"charSelect":t="";break;default:return}drawModel(Dialog_tile_imgs,t,a,r)}let dialogScoremodel="0 #r4 4 1 #n 2 #r4 6 3",lastTime=performance.now(),text_base_start_uuid=addText("   [시작]",-5,8.9,.65),text_base_char_uuid=addText("   [캐릭터]",-5,9.7,.65),text_base_setting_uuid=addText("   [설정]",-5,10.5,.65),text_score_uuid=addText("Score : N/A",2.85,-10,.65),select="start",screen_type="base",gameStartAnimated=!1,dialogEndY=.5,dialogScoreYpos=-10,renderAcc=0;function start(){screen_type="gameStart",map.update(player.start(map.data,camera)||camera),gameStartAnimated=!0,removeText(text_base_start_uuid),removeText(text_base_char_uuid),removeText(text_base_setting_uuid)}function ArrowUp(){if("base"===screen_type)switch(select){case"start":select="setting";break;case"char":select="start";break;case"setting":select="char"}}function ArrowDown(){if("base"===screen_type)switch(select){case"start":select="char";break;case"char":select="setting";break;case"setting":select="start";break;default:return}}function ArrowLeft(){}function ArrowRight(){}function Enter(){"base"===screen_type&&"start"===select&&start()}function onKeyDown(e){switch(e.key){case"ArrowUp":ArrowUp();break;case"ArrowDown":ArrowDown();break;case"ArrowLeft":ArrowLeft();break;case"ArrowRight":ArrowRight();break;case"z":case"Enter":Enter()}debug_mode.enabled&&"n"===e.key&&map.newline(camera.x)}function gameLoop(e){requestAnimationFrame(gameLoop);const t=(e-lastTime)/1e3;lastTime=e,gameStartAnimated&&(dialogScoreYpos+=.05*(dialogEndY-dialogScoreYpos),Math.abs(dialogEndY-dialogScoreYpos)<.01&&(dialogScoreYpos=dialogEndY,gameStartAnimated=!1)),renderAcc+=t;const a=1/(gameSetting.boostmode?60:30);if(!(renderAcc<a)){if(renderAcc-=a,clearScreen(),applyRenderState(),drawMap(camera,map.data),player.CharacterDraw(),drawModel(Dialog_tile_imgs,dialogScoremodel,2,dialogScoreYpos),!player.is_start){if(drawDialog(),"base"!==screen_type)return;switch(select){case"start":DrawTile(Dialog_tile_imgs[9],-5.3,8.7);break;case"char":DrawTile(Dialog_tile_imgs[9],-5.3,9.5);break;case"setting":DrawTile(Dialog_tile_imgs[9],-5.3,10.3)}}replaceText(text_score_uuid,`Score : ${player.height}`,2.85,dialogScoreYpos+.75,.5),drawTexts()}}window.addEventListener("keydown",onKeyDown),requestAnimationFrame(gameLoop),resizeCanvas();